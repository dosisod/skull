name: tests

on: [push, pull_request]

jobs:
  lint-and-semantics:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install clang-tidy
      run: sudo apt install clang-tidy-12

    - name: Run Clang Tidy
      run: |
        clang-tidy-12 --version
        make lint

    - name: Run Shellcheck
      run: |
        shellcheck --version
        shellcheck test/sh/main.sh Makefile

  test-gcc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install LLVM
      run: sudo apt install llvm-12-dev

    - name: Build
      run: make TRACE=1 CC=gcc-9 options clean all

    - name: Run tests
      run: ./build/test/test

    - name: Run Skull unit tests
      run: ./test/sh/main.sh

  test-clang:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install LLVM
      run: sudo apt install llvm-12-dev

    - name: Build
      run: make TRACE=1 CC=clang options clean all

    - name: Run tests
      run: ./build/test/test

    - name: Run Skull unit tests
      run: ./test/sh/main.sh

  tests-with-skull-installed:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Install LLVM
      run: sudo apt install llvm-12-dev

    - name: Build
      run: sudo make TRACE=1 CC=gcc-9 options install install-dev

    - name: Run Skull
      run: |
        skull test/main.sk
        ./test/main

    - name: Run C integration test
      run: |
        cd test/docs/c-integration
        make
