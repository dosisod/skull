#!/usr/bin/env bash

usage() {
	echo "usage: skull [ -v | file [ -o output ] [ -- args ]]"
	exit 0
}

[ -z "$1" ] && usage

# find -- seperator (if it exists)
sep=$(( $# + 1 ))

for (( i=1; i<=$#; i++ ))
do
	[ "${!i}" == "--" ] && sep=$i
done

if [ "$sep" == "$(( $# + 1 ))" ]; then
	pre="${@:1}"
else
	pre="${@:1:$(($sep - 1))}"
fi

# shift params if the first argument is not an option
case "$1" in
	-*) ;;
	*)
		filename=$1
		shift
		;;
esac

while getopts ":vh" o; do
	case "$o" in
		v) filename="-v" ;;
		h) usage; exit 0 ;;
	esac
done

$(dirname $0)/_skull $filename || exit 1

[[ "$filename" =~ ^.*\.sk$ ]] || exit 0

base=$(dirname $filename)/.$(basename $filename)

llc-9 $base.ll -filetype=obj || exit 1
rm $base.ll

cc $base.o -o "${1%.*}" "${@:$(($sep))}" -I/usr/include/skull
rm $base.o